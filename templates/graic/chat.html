{% extends "layouts/base.html" %}
{% load static get_attribute file_extension replace_value custom_filters %}

{% block content %}

<main>
    <div
        class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
        <div class="w-full mb-1">
            <div class="mx-10 space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <img src="{% static "dist/img/graic.jpg" %}" style="width: 35px; height: 35px;" class="rounded-lg" alt="">  
                        <p class="text-xl font-semibold">Hi! I'm <span class="text-blue-600">grAIc</span>.</p>
                    </div>
                    <div>
                        <p class="text-xl font-semibold">{{ greeting }}</p>
                    </div>
                    {% comment %} <button 
                        data-modal-target="pre-prompt-modal" 
                        data-modal-toggle="pre-prompt-modal"
                        type="button" 
                        class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                        Edit Pre-prompt
                    </button> {% endcomment %}
                </div>

                <div id="conversationWrapper" style="height: 50vh;" class="overflow-auto py-2">
                    <div id="conversation" class="space-y-4">
                        {% for entry in griac_data %}
                            <div class="bg-gray-50 p-4 rounded-xl shadow border border-gray-200">
                                <div class="flex justify-between items-start gap-5">
                                    <div class="flex items-start gap-2">
                                        <div>
                                            <strong class="text-gray-700">You:</strong> 
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-700" id="copyPrompt{{entry.id}}">
                                                {{ entry.prompt }}
                                            </span>
                                            <div onclick="copyPromptToClipboard('{{ entry.id }}')" style="cursor: pointer;" title="Copy to clipboard">
                                                <svg id="copyPromptBtn{{entry.id}}" class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M9 8v3a1 1 0 0 1-1 1H5m11 4h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-7a1 1 0 0 0-1 1v1m4 3v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-7.13a1 1 0 0 1 .24-.65L7.7 8.35A1 1 0 0 1 8.46 8H13a1 1 0 0 1 1 1Z"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-xs">{{ entry.created_at }}</small>
                                </div>
                                <div class="mt-4 text-gray-900">
                                    <div class="flex items-center gap-2">
                                        <img src="{% static "dist/img/graic.jpg" %}" style="width: 20px; height: 20px;" class="rounded-lg" alt="">
                                        <strong>grAIc:</strong>
                                    </div>
                                    {% if not entry.is_dt %}
                                    <div id="copyContent{{entry.id}}" class="prose prose-slate max-w-none mt-4">
                                        {% if entry.generated_file %}
                                        I completed your tasks as best as I could. Please download your file and review.
                                        <div class="mb-3 mt-3">
                                            <a class="inline-block border border-gray-300 rounded-lg px-5 py-2 no-underline bg-white hover:bg-gray-50" href="{{ entry.generated_file.url }}">{{ entry.file_name }}</a>
                                        </div>
                                        {{ entry.summary_response|safe }}
                                        {% else %}
                                        {{ entry.response|safe }}
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="mt-4">
                                        {% if entry.summary_response %}
                                        <div class="prose prose-slate max-w-none mb-3">
                                            {{ entry.summary_response|format_response|safe }}
                                        </div>
                                        {% endif %}
                                        <span class="block text-gray-500 text-base italic mb-3">AI response contains tabular data – click "View Dataset" to explore.</span>
                                        <button data-modal-target="view-dt-{{entry.id}}" data-modal-toggle="view-dt-{{entry.id}}" class="block mb-5 py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700" type="button">
                                            View Dataset
                                        </button>

                                        <div class="flex items-center gap-3">
                                            <div onclick="copyToClipboard('{{ entry.id }}')" style="cursor: pointer;" title="Copy to clipboard">
                                                <svg id="copyBtn{{entry.id}}" class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M9 8v3a1 1 0 0 1-1 1H5m11 4h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-7a1 1 0 0 0-1 1v1m4 3v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-7.13a1 1 0 0 1 .24-.65L7.7 8.35A1 1 0 0 1 8.46 8H13a1 1 0 0 1 1 1Z"/>
                                                </svg>
                                            </div>
                                            <a href="{% url "toggle_feedback" entry.id 'like' %}" class="feedback-btn" data-action="like" data-id="{{ entry.id }}">
                                                <svg class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11c.889-.086 1.416-.543 2.156-1.057a22.323 22.323 0 0 0 3.958-5.084 1.6 1.6 0 0 1 .582-.628 1.549 1.549 0 0 1 1.466-.087c.205.095.388.233.537.406a1.64 1.64 0 0 1 .384 1.279l-1.388 4.114M7 11H4v6.5A1.5 1.5 0 0 0 5.5 19v0A1.5 1.5 0 0 0 7 17.5V11Zm6.5-1h4.915c.286 0 .372.014.626.15.254.135.472.332.637.572a1.874 1.874 0 0 1 .215 1.673l-2.098 6.4C17.538 19.52 17.368 20 16.12 20c-2.303 0-4.79-.943-6.67-1.475"/>
                                                </svg>
                                            </a>
                                            <a href="{% url "toggle_feedback" entry.id 'dislike' %}" class="feedback-btn" data-action="dislike" data-id="{{ entry.id }}">
                                                <svg class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13c-.889.086-1.416.543-2.156 1.057a22.322 22.322 0 0 0-3.958 5.084 1.6 1.6 0 0 1-.582.628 1.549 1.549 0 0 1-1.466.087 1.587 1.587 0 0 1-.537-.406 1.666 1.666 0 0 1-.384-1.279l1.389-4.114M17 13h3V6.5A1.5 1.5 0 0 0 18.5 5v0A1.5 1.5 0 0 0 17 6.5V13Zm-6.5 1H5.585c-.286 0-.372-.014-.626-.15a1.797 1.797 0 0 1-.637-.572 1.873 1.873 0 0 1-.215-1.673l2.098-6.4C6.462 4.48 6.632 4 7.88 4c2.302 0 4.79.943 6.67 1.475"/>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>

                                    <div id="view-dt-{{entry.id}}" data-modal-backdrop="static" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                                        <div class="relative p-4 w-full max-w-7xl max-h-full">
                                            <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                                                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                                                    <div>
                                                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                                            <img src="{% static "dist/img/graic.jpg" %}" style="width: 25px; height: 25px;" class="rounded-lg" alt="">
                                                            Data
                                                        </h3>
                                                    </div>
                                                    <a href="{% url "export_ai_res_to_excel" %}?entry_id={{ entry.id }}" class="block">
                                                        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 15v2a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-2m-8 1V4m0 12-4-4m4 4 4-4"/>
                                                        </svg>
                                                    </a>
                                                    <div>
                                                        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="view-dt-{{entry.id}}">
                                                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                                            </svg>
                                                            <span class="sr-only">Close modal</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div style="height: 70vh;" class="p-4 space-y-4 overflow-y-auto">
                                                    {% with entry.response|extract_table_data as table_data %}
                                                        {% if table_data.columns %}
                                                            <div class="overflow-x-scroll">
                                                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                                                    <thead>
                                                                        <tr>
                                                                            {% for col in table_data.columns %}
                                                                            <th class="p-2 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400 whitespace-nowrap">{{ col }}</th>
                                                                            {% endfor %}
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                                                    {% for row in table_data.data %}
                                                                        <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                                                                        {% for col in table_data.columns %}
                                                                            <td class="p-4 text-base font-medium text-gray-900 dark:text-white whitespace-nowrap">{{ row|getattribute:col }}</td>
                                                                        {% endfor %}
                                                                        </tr>
                                                                    {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        {% else %}
                                                            <p class="text-gray-500">No valid data to display.</p>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex justify-between mt-3">
                                    <div class="flex items-center gap-3">
                                        {% if entry.generated_file %}
                                        <div title="Export response" data-modal-target="export-file-modal-{{ entry.pk }}" data-modal-toggle="export-file-modal-{{ entry.pk }}">
                                            <svg class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 15v2a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-2m-8 1V4m0 12-4-4m4 4 4-4"/>
                                            </svg>
                                        </div>
                                        {% else %}
                                        <div onclick="copyToClipboard('{{ entry.id }}')" style="cursor: pointer;" title="Copy to clipboard">
                                            <svg id="copyBtn{{entry.id}}" class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                <path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M9 8v3a1 1 0 0 1-1 1H5m11 4h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-7a1 1 0 0 0-1 1v1m4 3v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-7.13a1 1 0 0 1 .24-.65L7.7 8.35A1 1 0 0 1 8.46 8H13a1 1 0 0 1 1 1Z"/>
                                            </svg>
                                        </div>
                                        <div title="Export response" data-modal-target="export-modal-{{ entry.pk }}" data-modal-toggle="export-modal-{{ entry.pk }}">
                                            <svg class="w-6 h-6 text-gray-400 hover:text-gray-700 cursor-pointer dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 15v2a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-2m-8 1V4m0 12-4-4m4 4 4-4"/>
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <small class="text-xs">{{ entry.time_take|floatformat:"2" }}</small>
                                </div>
                            </div>

                            
                            <!-- Main modal -->
                            <div id="export-modal-{{ entry.pk }}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                                <div class="relative p-4 w-full max-w-xl max-h-full">
                                    <!-- Modal content -->
                                    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                                        <!-- Modal header -->
                                        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-3">
                                                <img src="/static/dist/img/graic.jpg" style="width: 25px; height: 25px;" class="rounded-lg" alt="">
                                                <span>Export</span>
                                            </h3>
                                            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm h-8 w-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-toggle="export-modal-{{ entry.pk }}">
                                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                                </svg>
                                                <span class="sr-only">Close modal</span>
                                            </button>
                                        </div>
                                        <div class="p-4 md:p-5">
                                            <div class="flex justify-between items-center gap-5">
                                                <button class="flex justify-center items-center w-full p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer" onclick="exportFile('{% url 'export_graic_word' entry.pk %}', '{{ entry.pk }}')" type="button">
                                                    <img class="w-10 h-10" src="{% static 'dist/images/docx.png' %}">
                                                </button>

                                                <button class="flex justify-center items-center w-full p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer" onclick="exportFile('{% url 'export_graic_excel' entry.pk %}', '{{ entry.pk }}')" type="button">
                                                    <img class="w-10 h-10" src="{% static 'dist/images/xlsx.png' %}">
                                                </button>

                                                <button class="flex justify-center items-center w-full p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer" onclick="exportFile('{% url 'export_graic_pdf' entry.pk %}', '{{ entry.pk }}')" type="button">
                                                    <img class="w-10 h-10" src="{% static 'dist/images/pdf.png' %}">
                                                </button>

                                                <button class="flex justify-center items-center w-full p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer" onclick="exportFile('{% url 'export_graic_markdown' entry.pk %}', '{{ entry.pk }}')" type="button">
                                                    <img class="w-10 h-10" src="{% static 'dist/images/markdown.png' %}">
                                                </button>
                                            </div>

                                            <div class="mt-4 space-y-2">
                                                <label class="flex items-center gap-2">
                                                    <input type="radio" name="export_target_{{ entry.pk }}" value="grc" checked>
                                                    <span>Save to GRC</span>
                                                </label>
                                                <label class="flex items-center gap-2">
                                                    <input type="radio" name="export_target_{{ entry.pk }}" value="download">
                                                    <span>Download to device</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> 

                            <div id="export-file-modal-{{ entry.pk }}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                                <div class="relative p-4 w-full max-w-xl max-h-full">
                                    <!-- Modal content -->
                                    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                                        <!-- Modal header -->
                                        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-3">
                                                <img src="/static/dist/img/graic.jpg" style="width: 25px; height: 25px;" class="rounded-lg" alt="">
                                                <span>Export</span>
                                            </h3>
                                            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm h-8 w-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-toggle="export-file-modal-{{ entry.pk }}">
                                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                                </svg>
                                                <span class="sr-only">Close modal</span>
                                            </button>
                                        </div>
                                        <div class="p-4 md:p-5" data-entry="{{ entry.pk }}">
                                            <div class="space-y-2">
                                                <label class="flex items-center gap-2">
                                                    <input type="radio" name="export_file_target_{{ entry.pk }}" value="grc" checked>
                                                    <span>Save to GRC</span>
                                                </label>
                                                <label class="flex items-center gap-2">
                                                    <input type="radio" name="export_file_target_{{ entry.pk }}" value="download">
                                                    <span>Download to device</span>
                                                </label>
                                            </div>
                                            <button class="bg-green-500 text-white px-5 py-2 text-sm rounded-md mt-4 export-generated-file-btn" data-entry="{{ entry.pk }}" type="button">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div> 

                        {% endfor %}
                    </div>
                    <div id="loading" class="flex justify-center mt-4 hidden">
                        <div class="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>

                <form id="askForm" method="post" class="p-4 rounded-xl border border-gray-200 shadow-lg bg-white" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="flex items-start gap-2">
                        <div class="flex flex-col gap-1 w-full mb-3">
                            <div class="flex items-start gap-1 border border-gray-300 rounded-xl px-2 focus-within:ring-2 focus-within:ring-blue-500 min-h-[40px]">
                                <!-- File Upload Icon -->
                                <div class="cursor-pointer flex-shrink-0" data-modal-target="file-chooser-modal" data-modal-toggle="file-chooser-modal">
                                    <svg class="w-6 h-6 text-gray-500 hover:text-gray-700 dark:text-white mt-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
                                    </svg>
                                </div>
                                
                                <!-- Hidden file input -->
                                <input type="file" name="file" class="hidden" accept=".xlsx, .xls" id="id_file">
                                <input type="hidden" name="existing_file_id" id="existing_file_id">

                                <!-- Textarea -->
                                <div class="flex-1">
                                    <textarea
                                        name="prompt"
                                        id="promptInput"
                                        placeholder="How can I help you today?"
                                        class="w-full bg-transparent border-0 focus:ring-0 resize-none outline-none px-1 py-2"
                                        rows="3"
                                        required
                                    ></textarea>
                                </div>
                            </div>

                            <!-- File Preview -->
                            <div id="filePreview" class="hidden mt-3 flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 bg-gray-50">
                                <a href="#" target="_blank" id="fileLink" class="flex-1 text-gray-700 truncate"></a>
                                <button type="button" id="removeFile" class="text-gray-500 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <div class="">
                                <label for="workflow" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Mode</label>
                                <select id="workflow" name="workflow" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                    <option selected>Choose a mode</option>
                                    <option selected value="summary">Multi Agent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button
                        type="submit"
                        class=""
                        data-tooltip-target="ask-graic" data-tooltip-placement="bottom"
                    >
                        <img src="{% static "dist/img/graic.jpg" %}" style="width: 35px; height: 35px;" class="rounded-lg" alt="">  
                    </button>
                    <div id="ask-graic" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                        Ask grAIc
                        <div class="tooltip-arrow" data-popper-arrow></div>
                    </div>
                </form>

            </div>

        </div>

    </div>
</main>

<div id="file-chooser-modal" data-modal-backdrop="static" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Choose file
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="file-chooser-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <div class="flex justify-between flex-col items-center gap-3">
                    <label for="id_file" class="flex justify-center items-center w-full p-3 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                        Upload from your device
                    </label>
                    <div class="flex items-center gap-3 w-full">
                        <div class="h-px flex-1 bg-gray-200"></div>
                        <span class="text-gray-500">or</span>
                        <div class="h-px flex-1 bg-gray-200"></div>
                    </div>
                    <button 
                        data-modal-hide="file-chooser-modal"
                        data-modal-target="file-manager-modal"
                        data-modal-toggle="file-manager-modal"
                        type="button" 
                        class="flex justify-center items-center w-full p-3 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                        Upload from GRC
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="file-manager-modal"
     tabindex="-1"
     aria-hidden="true"
     class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">

    <div class="relative p-4 w-full max-w-lg max-h-full">
        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    File Manager
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="file-manager-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>

            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">

                {% for f in files %}
                    <button type="button"
                            onclick="selectExistingFile(
                                '{{ f.id }}',
                                '{{ f.file.url }}',
                                '{{ f.file_name|escapejs }}'
                            )"
                            class="w-full flex justify-between items-center border rounded p-3 hover:bg-gray-100">
                        <span class="truncate">{{ f.file_name }}</span>
                    </button>
                {% empty %}
                    <p class="text-gray-500 text-center">No files found</p>
                {% endfor %}

            </div>
        </div>
    </div>
</div>


<div id="pre-prompt-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-2xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Pre-prompt
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-toggle="pre-prompt-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <form class="p-4 md:p-5" action="{% url "save_preprompt" %}" id="promptForm" method="post">
                {% csrf_token %}
                <div class="grid gap-4 mb-4 grid-cols-2">
                    <input type="hidden" id="hidden-workflow" name="workflow">
                    <div class="col-span-2">
                        <label for="pre-prompt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Pre-prompt</label>
                        <textarea id="pre-prompt" name="pre_prompt" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Pre-prompt"></textarea>
                    </div>
                    <div id="email_prompt_container" style="display: none;" class="col-span-2 mt-2">
                        <label for="email_prompt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Summarize prompt</label>
                        <textarea id="email_prompt" name="email_prompt" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Email prompt"></textarea>
                    </div>
                </div>
                <button type="submit" class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                    Save
                </button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
    const form = document.getElementById('askForm');
    const promptInput = document.getElementById('promptInput');
    const loading = document.getElementById('loading');
    const conversation = document.getElementById('conversation');
    const conversationWrapper = document.getElementById('conversationWrapper');
    
    function scrollToBottom() {
        conversationWrapper.scrollTop = conversationWrapper.scrollHeight;
    }

    function createResponseBlock(prompt, content, isError = false, timeTaken = 0) {
        const block = document.createElement('div');
        block.className = `bg-gray-50 p-4 rounded-xl shadow border border-gray-200 ${isError ? 'border-red-200 bg-red-50' : ''}`;
        
        const contentHTML = `
            <p class="text-gray-700"><strong>You:</strong> ${prompt}</p>
            <div class="mt-4 ${isError ? 'text-red-700' : 'text-gray-900'}">
                <strong>grAIc:</strong>
                <div class="prose prose-slate max-w-none mt-4">
                    ${content}
                </div>
            </div>
            <div class="flex justify-end">
                <small class="text-xs ${isError ? 'text-red-500' : ''}">${timeTaken.toFixed(2)}</small>
            </div>
        `;

        block.innerHTML = contentHTML;
        return block;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const prompt = promptInput.value.trim();
        if (!prompt) return;

        loading.classList.remove('hidden');
        scrollToBottom();

        const formData = new FormData(form);
        const csrfToken = formData.get('csrfmiddlewaretoken');
        formData.append('client_datetime', new Date().toISOString());

        const url = `{% url 'ask_graic' chat.uuid %}`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });

            const data = await res.json();
            
            if (!res.ok) {
                // Handle HTTP errors (4xx, 5xx)
                const errorBlock = createResponseBlock(
                    prompt,
                    data.error || 'An unexpected error occurred',
                    true,
                    data.time_taken || 0
                );
                conversation.appendChild(errorBlock);
            } 
            else if (data.response) {
                if (data.is_dt) {
                    window.location.reload();
                } else {
                    const responseBlock = createResponseBlock(
                        prompt,
                        data.response,
                        false,
                        data.time_taken
                    );
                    conversation.appendChild(responseBlock);
                    promptInput.value = '';
                    window.location.reload();
                }
            } else {
                // Handle API-level errors (when status is 200 but response contains error)
                const errorBlock = createResponseBlock(
                    prompt,
                    data.error || 'Something went wrong',
                    true,
                    data.time_taken || 0
                );
                conversation.appendChild(errorBlock);
            }

            scrollToBottom();

        } catch (err) {
            // Handle network errors or JSON parsing errors
            const errorBlock = createResponseBlock(
                prompt,
                'Error sending request. Please check your connection and try again.',
                true,
                0
            );
            conversation.appendChild(errorBlock);
            console.error(err);
        } finally {
            loading.classList.add('hidden');
        }
    });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('conversationWrapper');
    if (container) {
      container.scrollTop = container.scrollHeight;
    }
  });
</script>

<script>
  document.getElementById('promptForm').addEventListener('submit', function (e) {
    const externalValue = document.getElementById('workflow').value;
    document.getElementById('hidden-workflow').value = externalValue;
  });
</script>

<script>
    function copyToClipboard(entryId) {
        const contentElement = document.getElementById(`copyContent${entryId}`);
        if (contentElement) {
            const range = document.createRange();
            range.selectNode(contentElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert("Copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
    }
</script>

<script>
    function copyPromptToClipboard(entryId) {
        const promptElement = document.getElementById(`copyPrompt${entryId}`);
        if (promptElement) {
            const range = document.createRange();
            range.selectNode(promptElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert("Copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".feedback-btn").forEach(btn => {
            btn.addEventListener("click", function(event) {
                event.preventDefault();

                const entryId = this.dataset.id;
                const action = this.dataset.action;
                const url = this.getAttribute("href");

                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    },
                })
                .then(response => response.json())
                .then(data => {
                    alert("You " + (action === "like" ? "liked" : "disliked") + " this response.");
                })
                .catch(error => {
                    alert("Something went wrong.");
                    console.error(error);
                });
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("askForm");
        const textarea = document.getElementById("promptInput");

        textarea.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                form.requestSubmit();
            }
        });
    });
</script>

<script>
    const fileInput = document.getElementById('id_file');
    const filePreview = document.getElementById('filePreview');
    const fileLink = document.getElementById('fileLink');
    const removeBtn = document.getElementById('removeFile');
    const existingFileInput = document.getElementById('existing_file_id');

    const fileManagerEl = document.getElementById('file-manager-modal');
    const fileChooserEl = document.getElementById('file-chooser-modal');

    const fileManagerModal = new Modal(fileManagerEl);
    const fileChooserModal = new Modal(fileChooserEl);

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) return;

        existingFileInput.value = '';
        showPreview(file.name, URL.createObjectURL(file));

        fileChooserModal.hide();
        cleanupBackdrop();
    });

    function selectExistingFile(fileId, fileUrl, fileName) {
        existingFileInput.value = fileId;
        fileInput.value = '';

        showPreview(fileName, fileUrl);

        fileManagerModal.hide();
        fileChooserModal.hide();
        cleanupBackdrop();
    }

    function showPreview(name, url) {
        filePreview.classList.remove('hidden');
        fileLink.textContent = name;
        fileLink.href = url;
    }

    removeBtn.addEventListener('click', () => {
        fileInput.value = '';
        existingFileInput.value = '';
        filePreview.classList.add('hidden');
        fileLink.href = '#';
    });

    function cleanupBackdrop() {
        document.body.classList.remove('overflow-hidden');
        document.querySelectorAll('[modal-backdrop]').forEach(el => el.remove());
        document.querySelectorAll('.bg-gray-900\\/50').forEach(el => el.remove());
    }
</script>

<script>
    function copyLink() {
        const url = window.location.href;

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(url)
                .then(() => alert('URL copied!'))
                .catch(() => fallbackCopy(url));
        } else {
            fallbackCopy(url);
        }
    }

    function fallbackCopy(text) {
        const input = document.createElement("input");
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand("copy");
        document.body.removeChild(input);
        alert("URL copied!");
    }
</script>

<script>
function exportFile(url, entryId) {
    const radio = document.querySelector(
        `input[name="export_target_${entryId}"]:checked`
    );

    if (!radio) {
        alert("Please select export destination");
        return;
    }

    const destination = radio.value;

    fetch(url, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            destination: destination
        })
    })
    .then(async response => {
        const contentType = response.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
            const data = await response.json();
            alert("Saved to GRC");
            return;
        }

        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = downloadUrl;

        const disposition = response.headers.get("Content-Disposition");
        const match = disposition?.match(/filename="(.+)"/);
        a.download = match ? match[1] : "export";

        document.body.appendChild(a);
        a.click();
        a.remove();

        window.URL.revokeObjectURL(downloadUrl);
    })
    .catch(err => {
        console.error(err);
        alert("Export failed");
    });
}
</script>

<script>
    document.addEventListener("click", async function (e) {
        const btn = e.target.closest(".export-generated-file-btn");
        if (!btn) return;

        const entryId = btn.dataset.entry;
        const destination = document.querySelector(
            `input[name="export_file_target_${entryId}"]:checked`
        ).value;

        const formData = new FormData();
        formData.append("destination", destination);

        const res = await fetch(
            `/graic/export/generated-file/${entryId}/`,
            {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            }
        );

        if (destination === "download") {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            return;
        }

        const data = await res.json();
        if (data.success) {
            alert("File saved to GRC successfully");
        } else {
            alert("Failed to save file");
        }
    });
</script>


{% endblock extra_js %}