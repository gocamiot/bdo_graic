{% extends "layouts/base.html" %}
{% load static get_attribute file_extension replace_value custom_filters %}

{% block extrastyle %}

<style>
    .table-wrp  {
        max-height: 75vh;
        overflow-y: auto;
        display:block;
    }
    thead{
        position:sticky;
        top:0
    }
    .animated-dots::after {
        content: '';
        display: inline-block;
        width: 1ch;
        text-align: left;
        animation: dots 1s steps(3, end) infinite;
    }

    @keyframes dots {
        0% { content: ''; }
        33% { content: '.'; }
        66% { content: '..'; }
        100% { content: '...'; }
    }
</style>

{% endblock extrastyle %}

{% block content %}


<main>
    <div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
        <div class="w-full mb-1">
            <div class="mb-4">
                <ul class="mb-7 flex flex-wrap text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:border-gray-700 dark:text-gray-400">
                    <li class="me-2">
                        <a href="{% url base_chart.base_view %}" aria-current="page" class="{% if not 'risk-card' in request.path %} inline-block p-4 rounded-t-lg text-blue-600 bg-gray-100 active dark:bg-gray-600 dark:text-white {% else %} inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300 {% endif %}">{{ base_chart.base_view|replace_value:"_" }}</a>
                    </li>
                    {% for tab in tabs %}
                    <li class="me-2">
                        <div class="flex items-center gap-5 inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300">
                        <a href="{% url "tab_details" tab.id %}{% if tab.order_by %}?order_by={{tab.order_by}}{% endif %}" aria-current="page" class="">{{ tab.name }}</a>
                        {% if tab.id|stringformat:"s" not in request.path %}
                        <a
                            data-modal-target="remove-tab-{{tab.id}}" 
                            data-modal-toggle="remove-tab-{{tab.id}}" 
                            class="hover:bg-gray-200 rounded-sm p-px"
                        >
                            <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                            </svg>                  
                        </a>
                        {% endif %}
                        </div>
                    </li>

                    <div class="action-modal fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full" id="remove-tab-{{tab.id}}">
                        <div class="relative w-full h-full max-w-md px-4 md:h-auto">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                                <!-- Modal header -->
                                <div class="flex justify-end p-2">
                                    <button type="button" class="rotate-toggle-button text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-700 dark:hover:text-white" data-modal-toggle="remove-tab-{{tab.id}}">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                                    </button>
                                </div>
                                <!-- Modal body -->
                                <div class="p-6 pt-0 text-center">
                                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this tab?</h3>
                                    <a href="{% url "remove_tab" tab.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                                        Yes, I'm sure
                                    </a>
                                    <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-tab-{{tab.id}}">
                                        No, cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for chart in charts %}
                    <li class="me-2">
                        <div class="flex items-center gap-5 inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300">
                            <a href="{% url "chart_details" chart.id %}" aria-current="page" class="">{{ chart.name }}</a>
                            {% if chart.id|stringformat:"s" not in request.path %}
                            <a 
                                data-modal-target="remove-chart-{{chart.id}}" 
                                data-modal-toggle="remove-chart-{{chart.id}}"
                                class="hover:bg-gray-200 rounded-sm p-px"
                            >
                                <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                                </svg>                  
                            </a>
                            {% endif %}
                        </div>
                    </li>

                    <div class="action-modal fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full" id="remove-chart-{{chart.id}}">
                        <div class="relative w-full h-full max-w-md px-4 md:h-auto">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                                <!-- Modal header -->
                                <div class="flex justify-end p-2">
                                    <button type="button" class="rotate-toggle-button text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-700 dark:hover:text-white" data-modal-toggle="remove-chart-{{chart.id}}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                                    </button>
                                </div>
                                <!-- Modal body -->
                                <div class="p-6 pt-0 text-center">
                                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this chart?</h3>
                                    <a href="#" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                                        Yes, I'm sure
                                    </a>
                                    <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-chart-{{chart.id}}">
                                        No, cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% for chart in risk_charts %}
                    <li class="me-2">
                        <div class="flex items-center gap-5 inline-block p-4 rounded-t-lg text-blue-600 bg-gray-100 active dark:bg-gray-600 dark:text-white">
                            <a href="#" aria-current="page" class="">{{ chart.name }}</a>
                                <a 
                                    data-modal-target="remove-chart-{{chart.id}}" 
                                    data-modal-toggle="remove-chart-{{chart.id}}"
                                    class="hover:bg-gray-200 rounded-sm p-px"
                                >
                                <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                                </svg>                  
                            </a>
                        </div>
                    </li>

                    <div class="action-modal fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full" id="remove-chart-{{chart.id}}">
                        <div class="relative w-full h-full max-w-md px-4 md:h-auto">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                                <!-- Modal header -->
                                <div class="flex justify-end p-2">
                                    <button type="button" class="rotate-toggle-button text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-700 dark:hover:text-white" data-modal-toggle="remove-chart-{{chart.id}}">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                                    </button>
                                </div>
                                <!-- Modal body -->
                                <div class="p-6 pt-0 text-center">
                                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this chart?</h3>
                                    <a href="#" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                                        Yes, I'm sure
                                    </a>
                                    <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-chart-{{chart.id}}">
                                        No, cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </ul>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 py-4">
                {% for item in tab_heatmaps %}
                <div class="col-span-1 bg-white rounded-2xl shadow p-4 flex flex-col relative">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-semibold">{{ item.tab.name }}</h2>
                        <div class="flex items-center gap-3 mt-1">

                            <button 
                                data-modal-target="schedule-export-heatmap-modal-{{ item.tab.id}}" data-modal-toggle="schedule-export-heatmap-modal-{{ item.tab.id}}"
                                data-tooltip-target="schedule-export-heatmap-tooltip-{{ item.tab.id}}" data-tooltip-placement="bottom"
                                type="button" class="text-green-600 hover:text-green-800">
                                
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                </svg>
                            </button>
                            <div id="schedule-export-heatmap-tooltip-{{ item.tab.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                                Schedule Export Heatmap
                                <div class="tooltip-arrow" data-popper-arrow></div>
                            </div>

                            <button 
                                data-modal-target="export-heatmap-modal-{{ item.tab.id}}" data-modal-toggle="export-heatmap-modal-{{ item.tab.id}}"
                                data-tooltip-target="export-heatmap-tooltip-{{ item.tab.id}}" data-tooltip-placement="bottom"
                                type="button" class="text-blue-600 hover:text-blue-800">
                                <img src="{% static "dist/img/graic.jpg" %}" style="width: 20px; height: 20px;" class="rounded-lg" alt="">
                            </button>
                            <div id="export-heatmap-tooltip-{{ item.tab.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                                Export Heatmap
                                <div class="tooltip-arrow" data-popper-arrow></div>
                            </div>

                            <a
                                href="{% url "tab_details" item.tab.id %}" 
                                data-tooltip-target="edit-chart-tooltip-{{ item.tab.id}}" data-tooltip-placement="bottom"
                                type="button" class="text-blue-600 hover:text-blue-800">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                </svg>
                            </a>
                            <div id="edit-chart-tooltip-{{ item.tab.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                                Edit Heatmap
                                <div class="tooltip-arrow" data-popper-arrow></div>
                            </div>
                
                            <button 
                                data-modal-target="delete-chart-modal-{{ item.tab.id}}" data-modal-toggle="delete-chart-modal-{{ item.tab.id}}"
                                data-tooltip-target="delete-chart-tooltip-{{ item.tab.id}}" data-tooltip-placement="bottom"
                                type="button" class="text-red-600 hover:text-red-800">
                                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
                                </svg>
                            </button>
                            <div id="delete-chart-tooltip-{{ item.tab.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
                                Delete Heatmap
                                <div class="tooltip-arrow" data-popper-arrow></div>
                            </div>
                        </div>
                    </div>
                    <div id="risk-card-{{ item.tab.id }}" class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-teal-800 text-white text-sm text-center font-semibold py-2">RISK ASSESSMENT MATRIX</div>
                        <div class="grid grid-cols-5 text-xs font-semibold">
                            <div class="bg-gray-400 text-white flex items-center justify-center">Probability / Severity</div>
                            <div class="bg-gray-400 text-white text-center py-4">1-Catastrophic</div>
                            <div class="bg-gray-400 text-white text-center py-4">2-Critical</div>
                            <div class="bg-gray-400 text-white text-center py-4">3-Marginal</div>
                            <div class="bg-gray-400 text-white text-center py-4">4-Negligible</div>
                        </div>

                        {% for likelihood, row in item.risk_matrix.items %}
                        <div class="grid grid-cols-5 text-xs font-medium">
                            <div class="bg-gray-400 text-white flex items-center justify-center py-3">{{ likelihood|title }}</div>

                            {% for impact, value in row.items %}
                            {% with cell_key=likelihood|add:"|"|add:impact %}
                            {% with risks=item.heatmap_data|dict_get:cell_key %}

                            <div class="
                                relative flex flex-col items-center justify-center py-3 border
                                {% if value == 'High' %}bg-red-600 text-white
                                {% elif value == 'Serious' %}bg-yellow-500
                                {% elif value == 'Medium' %}bg-yellow-300
                                {% elif value == 'Low' %}bg-green-500 text-white
                                {% elif value == 'Eliminated' %}bg-teal-800 text-white
                                {% endif %}
                            ">
                                <span>{{ value }}</span>
                                {% with percentage=item.cell_confidence|dict_get:cell_key %}
                                    {% if percentage %}
                                        <span
                                        class="absolute top-1 right-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded-full"
                                        >
                                        {{ percentage }}%
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </div>

                            {% endwith %}
                            {% endwith %}
                            {% endfor %}
                        </div>
                        {% endfor %}

                    </div>
                    {% if item.risk.description.html %}
                    <div class="mt-3 flex items-center gap-2">
                        <span class="font-bold">Risk:</span> {{ item.risk.description.html|safe }}
                    </div>
                    {% endif %}
                </div>

                <div id="schedule-export-heatmap-modal-{{ item.tab.id}}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                    <div class="relative p-4 w-full max-w-lg max-h-full">
                        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-3">
                                    <img src="{% static "dist/img/graic.jpg" %}" style="width: 25px; height: 25px;" class="rounded-lg" alt="">
                                    <span>Schedule Export</span>
                                </h3>
                                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="schedule-export-heatmap-modal-{{ item.tab.id}}">
                                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
                            </div>

                            <div class="p-4 md:p-5">
                                <div class="mb-3">
                                    <label for="prompt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Additional Instruction to grAIc</label>
                                    <textarea id="custom_prompt_{{ item.tab.id}}" name="custom_prompt" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="If you have any additional instructions for grAic, please type here."></textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">Frequency</label>
                                    <select id="schedule_frequency_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                        <option value="once">One time</option>
                                        <option value="hourly">Hourly</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">Start date & time</label>
                                    <input type="datetime-local" id="schedule_start_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">
                                        End date (optional)
                                    </label>
                                    <input type="datetime-local" id="schedule_end_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">
                                        Repeat every (hours)
                                    </label>
                                    <input type="number" min="1" value="1" id="hour_interval_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">
                                        Time of day
                                    </label>
                                    <input type="time" id="schedule_time_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                </div>
                                <div class="mb-4" id="weekdays_block_{{ item.tab.id }}">
                                    <label class="block mb-2 text-sm font-medium">
                                        Days of week
                                    </label>
                                    <div class="grid grid-cols-4 gap-2 text-sm">
                                        <div class="flex items-center">
                                            <input id="mon-{{ item.tab.id }}" type="checkbox" value="mon" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="mon-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Mon</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="tue-{{ item.tab.id }}" type="checkbox" value="tue" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="tue-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Tue</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="wed-{{ item.tab.id }}" type="checkbox" value="wed" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="wed-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Wed</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="thu-{{ item.tab.id }}" type="checkbox" value="thu" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="thu-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Thu</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="fri-{{ item.tab.id }}" type="checkbox" value="fri" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="fri-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Fri</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="sat-{{ item.tab.id }}" type="checkbox" value="sat" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="sat-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Sat</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="sun-{{ item.tab.id }}" type="checkbox" value="sun" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="sun-{{ item.tab.id }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Sun</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-medium">
                                        Day of month (1â€“31)
                                    </label>
                                    <input type="number" min="1" max="31" id="month_day_{{ item.tab.id}}" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                </div>

                                <div class="flex justify-between items-center gap-5">
                                    <button 
                                        data-export="docx"
                                        onclick="selectExportType('{{ item.tab.id}}', 'docx')"
                                        type="button" 
                                        class="export-type-btn flex justify-center items-center w-full h-20 p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                                        <img class="w-10 h-10" src="{% static 'dist/images/docx.png' %}" alt="">
                                    </button>

                                    <button 
                                        data-export="pdf"
                                        onclick="selectExportType('{{ item.tab.id}}', 'pdf')"
                                        type="button" 
                                        class="export-type-btn flex justify-center items-center w-full h-20 p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                                        <img class="w-10 h-10" src="{% static 'dist/images/pdf.png' %}" alt="">
                                    </button>
                                </div>
                                <input type="hidden" id="selected_export_type_{{ item.tab.id}}" value="docx">

                                <button
                                    type="button"
                                    onclick="scheduleRiskExportFromModal('{{ item.tab.id}}', '{{ item.risk.id }}')"
                                    class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                >
                                    Export
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                <div id="export-heatmap-modal-{{ item.tab.id}}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                    <div class="relative p-4 w-full max-w-md max-h-full">
                        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-3">
                                    <img src="{% static "dist/img/graic.jpg" %}" style="width: 25px; height: 25px;" class="rounded-lg" alt="">
                                    <span>Export</span>
                                </h3>
                                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="export-heatmap-modal-{{ item.tab.id}}">
                                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
                            </div>

                            <div class="p-4 md:p-5">
                                
                                <div class="mb-3">
                                    <label for="prompt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Additional Instruction to grAIc</label>
                                    <textarea id="custom_prompt_{{ item.tab.id}}" name="custom_prompt" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="If you have any additional instructions for grAic, please type here."></textarea>
                                </div>

                                <div class="flex justify-between items-center gap-5">
                                    <button onclick="exportHeatmap(this, '{{ item.tab.id }}', '{{ item.risk.id }}', 'docx')" type="button" class="flex justify-center items-center w-full h-20 p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                                        <img class="w-10 h-10" src="{% static "dist/images/docx.png" %}" alt="">
                                    </button>
                                    <button onclick="exportHeatmap(this, '{{ item.tab.id }}', '{{ item.risk.id }}', 'pdf')" type="button" class="flex justify-center items-center w-full h-20 p-5 text-gray-900 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg cursor-pointer">
                                        <img class="w-10 h-10" src="{% static "dist/images/pdf.png" %}" alt="">
                                    </button>
                                </div>
                                <div class="mt-4 space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="export_target_{{ item.tab.id}}" value="grc" checked>
                                        <span>Save to GRC</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="export_target_{{ item.tab.id}}" value="download">
                                        <span>Download to device</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="delete-chart-modal-{{ item.tab.id}}" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                    <div class="relative p-4 w-full max-w-md max-h-full">
                        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                            <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="delete-chart-modal-{{ item.tab.id}}">
                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                </svg>
                                <span class="sr-only">Close modal</span>
                            </button>
                            <div class="p-4 md:p-5 text-center">
                                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                </svg>
                                <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Are you sure you want to delete this score card?</h3>
                                <a href="{% url "delete_score_card" item.score_card.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
                                    Yes, I'm sure
                                </a>
                                <button data-modal-hide="delete-chart-modal-{{ item.tab.id}}" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">No, cancel</button>
                            </div>
                        </div>
                    </div>
                </div>


                {% endfor %}
            </div>
        <div>
    </div>
</main>

{% endblock %}


{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
    async function captureRiskCard(tabId) {
        const element = document.getElementById(`risk-card-${tabId}`);
        if (!element) return null;

        const canvas = await html2canvas(element, {
            backgroundColor: "#ffffff",
            scale: 2
        });

        return canvas.toDataURL("image/png");
    }
</script>

<script>
    async function exportHeatmap(button, tabId, riskId, format) {
        const originalHTML = button.innerHTML;

        button.innerHTML = '<span class="animated-dots">Analyzing</span>';
        button.disabled = true;

        try {
            const imageData = await captureRiskCard(tabId);
            if (!imageData) throw "Capture failed";

            const customPrompt = document.getElementById(`custom_prompt_${tabId}`).value;
            const exportTarget = document.querySelector(
                `input[name="export_target_${tabId}"]:checked`
            ).value;

            const formData = new FormData();
            formData.append("risk_id", riskId);
            formData.append("custom_prompt", customPrompt);
            formData.append("export_option", exportTarget);
            formData.append("heatmap_image", imageData);

            const url = format === "docx"
                ? "{% url 'export_risk_docx' %}"
                : "{% url 'export_risk_pdf' %}";

            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            });

            if (exportTarget === "grc") {
                alert('File saved to GRC.');
            }
            else if (exportTarget === "download") {
                const blob = await res.blob();
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);

                let filename = format === "docx" ? "risk.docx" : "risk.pdf";
                const cd = res.headers.get("Content-Disposition");
                if (cd && cd.includes("filename=")) {
                    filename = cd.split("filename=")[1].replace(/"/g, '');
                }

                a.download = filename;
                a.click();
            }
        } catch (err) {
            alert("Export failed");
        } finally {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
</script>

<script>
    function initScheduleLogic(id) {
        const frequency = document.getElementById(`schedule_frequency_${id}`);

        const blocks = {
            start: document.getElementById(`schedule_start_${id}`)?.closest('.mb-4'),
            end: document.getElementById(`schedule_end_${id}`)?.closest('.mb-4'),
            hourInterval: document.getElementById(`hour_interval_${id}`)?.closest('.mb-4'),
            timeOfDay: document.getElementById(`schedule_time_${id}`)?.closest('.mb-4'),
            weekdays: document.getElementById(`weekdays_block_${id}`),
            monthDay: document.getElementById(`month_day_${id}`)?.closest('.mb-4'),
        };

        function hideAll() {
            Object.values(blocks).forEach(el => {
                if (el) el.style.display = 'none';
            });
        }

        function updateVisibility() {
            hideAll();

            const freq = frequency.value;

            blocks.start.style.display = 'block';
            blocks.end.style.display = 'block';

            if (freq === 'hourly') {
                blocks.hourInterval.style.display = 'block';
            }

            if (freq === 'daily') {
                blocks.timeOfDay.style.display = 'block';
            }

            if (freq === 'weekly') {
                blocks.timeOfDay.style.display = 'block';
                blocks.weekdays.style.display = 'block';
            }

            if (freq === 'monthly') {
                blocks.timeOfDay.style.display = 'block';
                blocks.monthDay.style.display = 'block';
            }
        }

        frequency.addEventListener('change', updateVisibility);
        updateVisibility();
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% for item in tab_heatmaps %}
            initScheduleLogic('{{ item.tab.id }}');
        {% endfor %}
    });
</script>

<script>
    async function scheduleRiskExportFromModal(tabId, riskId) {
        const button = document.querySelector(`#schedule_button_${tabId}`) || event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span class="animated-dots">Scheduling...</span>';
        button.disabled = true;

        try {
            const imageData = await captureRiskCard(tabId);

            const customPrompt = document.getElementById(`custom_prompt_${tabId}`).value;
            const frequency = document.getElementById(`schedule_frequency_${tabId}`).value;
            const startAt = document.getElementById(`schedule_start_${tabId}`).value;
            const endAt = document.getElementById(`schedule_end_${tabId}`).value;
            const hourInterval = document.getElementById(`hour_interval_${tabId}`).value;
            const timeOfDay = document.getElementById(`schedule_time_${tabId}`).value;
            const monthDay = document.getElementById(`month_day_${tabId}`).value;

            const weekdays = [];
            ['mon','tue','wed','thu','fri','sat','sun'].forEach(day => {
                const el = document.getElementById(`${day}-${tabId}`);
                if (el && el.checked) weekdays.push(day);
            });

            const formData = new FormData();
            formData.append("risk_id", riskId);
            formData.append("custom_prompt", customPrompt);
            formData.append("frequency", frequency);
            formData.append("start_at", startAt);
            if (endAt) formData.append("end_at", endAt);
            if (hourInterval) formData.append("hour_interval", hourInterval);
            if (timeOfDay) formData.append("time_of_day", timeOfDay);
            if (monthDay) formData.append("month_day", monthDay);
            formData.append("weekdays[]", weekdays);
            formData.append("chart_image", imageData || "");
            formData.append("export_type", document.getElementById(`selected_export_type_${tabId}`).value);
            formData.append("export_option", "grc");

            const res = await fetch("{% url 'create_risk_export_schedule' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            });

            const data = await res.json();

            if (data.status === "scheduled") {
                alert(`Risk export scheduled successfully (ID: ${data.schedule_id})`);
            } else {
                alert("Failed to schedule risk export");
            }
        } catch (err) {
            console.error(err);
            alert("Scheduling failed");
        } finally {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }

    function selectExportType(tabId, type) {
        const hiddenInput = document.getElementById(`selected_export_type_${tabId}`);
        hiddenInput.value = type;

        const modal = document.getElementById(`schedule-export-heatmap-modal-${tabId}`);

        modal.querySelectorAll(".export-type-btn").forEach(btn => {
            btn.classList.remove("ring-2", "ring-blue-500", "bg-blue-50");
        });
        const selected = modal.querySelector(`[data-export="${type}"]`);
        selected.classList.add("ring-2", "ring-blue-500", "bg-blue-50");
    }
</script>


{% endblock extra_js %}
