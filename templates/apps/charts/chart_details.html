{% extends "layouts/base.html" %}
{% load static get_attribute file_extension replace_value custom_filters %}

{% block extrastyle %}

<style>
  .table-wrp  {
    max-height: 75vh;
    overflow-y: auto;
    display:block;
  }
  thead{
    position:sticky;
    top:0
  }
</style>

{% endblock extrastyle %}

{% block content %}


<main>
    <div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
        <div class="w-full mb-1">
            <div class="mb-4">
                <ul class="mb-7 flex flex-wrap text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:border-gray-700 dark:text-gray-400">
                    <li class="me-2">
                        <a href="{% url base_chart.base_view %}" aria-current="page" class="{% if not 'chart' in request.path %} inline-block p-4 rounded-t-lg text-blue-600 bg-gray-100 active dark:bg-gray-600 dark:text-white {% else %} inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300 {% endif %}">{{ base_chart.base_view|replace_value:"_" }}</a>
                    </li>
                    {% for tab in tabs %}
                    <li class="me-2">
                        <div class="flex items-center gap-5 {% if tab.id|stringformat:"s" in request.path %} inline-block p-4 rounded-t-lg text-blue-600 bg-gray-100 active dark:bg-gray-600 dark:text-white {% else %} inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300 {% endif %}">
                        <a href="{% url "tab_details" tab.id %}{% if tab.order_by %}?order_by={{tab.order_by}}{% endif %}" aria-current="page" class="">{{ tab.name }}</a>
                        {% if tab.id|stringformat:"s" not in request.path %}
                        <a
                            data-modal-target="remove-tab-{{tab.id}}" 
                            data-modal-toggle="remove-tab-{{tab.id}}" 
                            class="hover:bg-gray-200 rounded-sm p-px"
                        >
                            <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                            </svg>                  
                        </a>
                        {% endif %}
                        </div>
                    </li>

                    <div class="action-modal fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full" id="remove-tab-{{tab.id}}">
                        <div class="relative w-full h-full max-w-md px-4 md:h-auto">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                                <!-- Modal header -->
                                <div class="flex justify-end p-2">
                                    <button type="button" class="rotate-toggle-button text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-700 dark:hover:text-white" data-modal-toggle="remove-tab-{{tab.id}}">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                                    </button>
                                </div>
                                <!-- Modal body -->
                                <div class="p-6 pt-0 text-center">
                                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this tab?</h3>
                                    <a href="{% url "remove_tab" tab.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                                        Yes, I'm sure
                                    </a>
                                    <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-tab-{{tab.id}}">
                                        No, cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for chart in charts %}
                    <li class="me-2">
                        <div class="flex items-center gap-5 {% if chart.id|stringformat:"s" in request.path %} inline-block p-4 rounded-t-lg text-blue-600 bg-gray-100 active dark:bg-gray-600 dark:text-white {% else %} inline-block p-4 rounded-t-lg hover:text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:hover:text-gray-300 {% endif %}">
                            <a href="#" aria-current="page" class="">{{ chart.name }}</a>
                            {% if chart.id|stringformat:"s" not in request.path %}
                            <a 
                                data-modal-target="remove-chart-{{chart.id}}" 
                                data-modal-toggle="remove-chart-{{chart.id}}"
                                class="hover:bg-gray-200 rounded-sm p-px"
                            >
                                <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
                                </svg>                  
                            </a>
                            {% endif %}
                        </div>
                    </li>

                    <div class="action-modal fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full" id="remove-chart-{{chart.id}}">
                        <div class="relative w-full h-full max-w-md px-4 md:h-auto">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
                                <!-- Modal header -->
                                <div class="flex justify-end p-2">
                                    <button type="button" class="rotate-toggle-button text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-700 dark:hover:text-white" data-modal-toggle="remove-chart-{{chart.id}}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                                    </button>
                                </div>
                                <!-- Modal body -->
                                <div class="p-6 pt-0 text-center">
                                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this chart?</h3>
                                    <a href="#" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                                        Yes, I'm sure
                                    </a>
                                    <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-chart-{{chart.id}}">
                                        No, cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </ul>
            </div>

            <div id="charts-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 p-4"></div>
            <div id="modal-root"></div>
        <div>
    </div>
</main>

{% endblock %}


{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>


<script>
    const chartData = {{ chart_data|safe }};
    const container = document.getElementById("charts-container");

    const DEFAULT_FIELD_OPTIONS_HTML = `
        <option value="">Select Field</option>
        {% for field in fields %}
            <option value="{{ field.name }}" data-type="{{ field.type }}"
              ${fieldName === '{{ field.name }}' ? 'selected' : ''}>
              {{ field.name|rename_field:join_model_instance }}
            </option>
        {% endfor %}
    `;

    function safeParseFilters(x) {
        if (!x) return [];
        if (Array.isArray(x)) return x;
        try { return JSON.parse(x); } catch (e) { return []; }
    }

    function setSummaryTextNamespaced(chartId, index, valueStart, valueEnd, isNot, isNull, isNotNull, isUnique, isCount) {
        const selectEl = document.querySelector(`[name="field_name_${chartId}_${index}"]`);
        const fieldType = selectEl && selectEl.options[selectEl.selectedIndex] ? selectEl.options[selectEl.selectedIndex].getAttribute('data-type') : null;

        let summaryText = '';
        if (valueStart && valueEnd) {
            summaryText = `From: ${valueStart} â†’ To: ${valueEnd}`;
        } else if (valueStart) {
            if (fieldType === 'Text') {
                summaryText = valueStart;
            } else {
                summaryText = `From: ${valueStart}`;
            }
        } else if (valueEnd) {
            summaryText = `To: ${valueEnd}`;
        } else {
            summaryText = 'Options';
        }

        let badges = [];
        if (isNot) badges.push('<span class="badge bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">not</span>');
        if (isNull) badges.push('<span class="badge bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">null</span>');
        if (isNotNull) badges.push('<span class="badge bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">!null</span>');
        if (isUnique) badges.push('<span class="badge bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">!</span>');
        if (isCount) badges.push('<span class="badge bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">!#</span>');

        const button = document.getElementById(`options-button_${chartId}_${index}`);
        if (button) button.innerHTML = `${summaryText} ${badges.join(' ')}`;
    }

    function updateInputsNamespaced(chartId, index, valueStart = '', valueEnd = '') {
        const select = document.querySelector(`[name="field_name_${chartId}_${index}"]`);
        const inputArea = document.getElementById(`input-area_${chartId}_${index}`);
        if (!select || !inputArea) return;

        const fieldType = select.options[select.selectedIndex]?.getAttribute("data-type") || null;
        let html = "";

        if (fieldType === "Text") {
            html = `
                <div>
                    <input 
                        type="text" 
                        name="value_start_${chartId}_${index}"
                        placeholder="Enter value"
                        class="input-field bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueStart)}"
                    >
                </div>`;
        } else if (fieldType === "Date") {
            html = `
                <div class="flex items-center">
                    <input 
                        type="date"
                        name="value_start_${chartId}_${index}"
                        class="input-field bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueStart)}"
                    >
                    <input 
                        type="date"
                        name="value_end_${chartId}_${index}"
                        class="input-field bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-r-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueEnd)}"
                    >
                </div>`;
        } else if (fieldType === "Integer" || fieldType === "Float" || fieldType === "Number") {
            html = `
                <div class="flex items-center">
                    <input 
                        type="number"
                        name="value_start_${chartId}_${index}"
                        placeholder="From"
                        class="input-field w-28 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueStart)}"
                    >
                    <input 
                        type="number"
                        name="value_end_${chartId}_${index}"
                        placeholder="To"
                        class="input-field w-28 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-r-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueEnd)}"
                    >
                </div>`;
        } else {
            html = `
                <div>
                    <input 
                        type="text"
                        name="value_start_${chartId}_${index}"
                        placeholder="Enter value"
                        class="input-field bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        value="${escapeHtml(valueStart)}"
                    >
                </div>`;
        }

        inputArea.innerHTML = html;

        const isNot = document.getElementById(`is_not_${chartId}_${index}`)?.checked || false;
        const isNull = document.getElementById(`is_null_${chartId}_${index}`)?.checked || false;
        const isNotNull = document.getElementById(`is_not_null_${chartId}_${index}`)?.checked || false;
        const isUnique = document.getElementById(`is_unique_${chartId}_${index}`)?.checked || false;
        const isCount = document.getElementById(`is_count_${chartId}_${index}`)?.checked || false;

        setSummaryTextNamespaced(
            chartId, index,
            valueStart, valueEnd,
            isNot, isNull, isNotNull, isUnique, isCount
        );

        const vs = document.querySelector(`[name="value_start_${chartId}_${index}"]`);
        const ve = document.querySelector(`[name="value_end_${chartId}_${index}"]`);

        if (vs) vs.addEventListener("input", () => {
            setSummaryTextNamespaced(
                chartId, index,
                vs.value || "",
                ve?.value || "",
                isNot, isNull, isNotNull, isUnique, isCount
            );
        });

        if (ve) ve.addEventListener("input", () => {
            setSummaryTextNamespaced(
                chartId, index,
                vs?.value || "",
                ve.value || "",
                isNot, isNull, isNotNull, isUnique, isCount
            );
        });
    }


    function toggleOptionsNamespaced(chartId, index) {
        const container = document.getElementById(`options-container_${chartId}_${index}`);
        if (!container) return;
        container.classList.toggle('hidden');
    }

    function deleteFilterNamespaced(chartId, index, filterId = null) {
        const filterDiv = document.querySelector(`#filters-area_${chartId} [data-filter-index="${index}"]`);
        if (filterId) {
            const csrfTokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenEl ? csrfTokenEl.value : null;
            const data = new FormData();
            data.append('filter_id', filterId);
            if (csrfToken) data.append('csrfmiddlewaretoken', csrfToken);

            fetch("{% url 'delete_saved_filter' %}", {
                method: 'POST',
                body: data,
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    if (filterDiv) filterDiv.remove();
                } else {
                    alert('Failed to delete filter');
                }
            }).catch(err => {
                console.error(err);
                alert('Failed to delete filter (network error)');
            });
        } else {
            if (filterDiv) filterDiv.remove();
        }
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#039;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function buildFieldOptions(fields) {
        if (!fields || !Array.isArray(fields)) return "";

        return fields
            .map(f => `<option value="${f.name}" data-type="${f.type}">${f.name}</option>`)
            .join("");
    }

    function addFilterNamespaced(chartId, index, fieldName = '', valueStart = '', valueEnd = '', isNot = false, isNull = false, isNotNull = false, isUnique = false, isCount = false, filterId = null) {
        const container = document.getElementById(`filters-area_${chartId}`);
        if (!container) return;

        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter-group mt-1';
        filterDiv.setAttribute('data-filter-index', index);

        const optionsHtml = buildFieldOptions(chartData[chartId].fields);

        filterDiv.innerHTML = `
            <div class="flex items-start gap-2">
                <select name="field_name_${chartId}_${index}" id="field_name_${chartId}_${index}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block p-2">
                    ${optionsHtml}
                </select>

                <div>
                    <button type="button" onclick="toggleOptionsNamespaced('${chartId}', ${index})" id="options-button_${chartId}_${index}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block p-2">Loading...</button>

                    <div id="options-container_${chartId}_${index}" class="absolute mt-2 bg-white shadow-lg border rounded p-3 hidden" style="z-index: 9999;">
                        <div class="input-area" id="input-area_${chartId}_${index}">
                            <!-- dynamic inputs will be injected here -->
                        </div>

                        <div class="mt-3">
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="is_not_${chartId}_${index}" name="is_not_${chartId}_${index}" ${isNot ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_not_${chartId}_${index}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Not</label>
                            </div>
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="is_null_${chartId}_${index}" name="is_null_${chartId}_${index}" ${isNull ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_null_${chartId}_${index}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Null</label>
                            </div>
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="is_not_null_${chartId}_${index}" name="is_not_null_${chartId}_${index}" ${isNotNull ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_not_null_${chartId}_${index}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Not Null</label>
                            </div>
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="is_unique_${chartId}_${index}" name="is_unique_${chartId}_${index}" ${isUnique ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_unique_${chartId}_${index}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Unique</label>
                            </div>
                            <div class="flex items-center mb-1">
                                <input type="checkbox" id="is_count_${chartId}_${index}" name="is_count_${chartId}_${index}" ${isCount ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_count_${chartId}_${index}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Count</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="filter_id_${chartId}_${index}" value="${filterId ? escapeHtml(filterId) : ''}">
            </div>
        `;
        // <button type="button" onclick="deleteFilterNamespaced('${chartId}', ${index}, ${filterId ? `'${filterId}'` : null})" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 font-medium rounded-lg text-sm px-3 py-2">X</button>

        container.appendChild(filterDiv);

        if (fieldName) {
            const sel = filterDiv.querySelector(`#field_name_${chartId}_${index}`);
            if (sel) {
                const opt = sel.querySelector(`option[value="${fieldName}"]`);
                if (opt) opt.selected = true;
            }
        }

        const selEl = filterDiv.querySelector(`#field_name_${chartId}_${index}`);
        if (selEl) {
            selEl.addEventListener('change', () => {
                updateInputsNamespaced(chartId, index);
            });
        }

        updateInputsNamespaced(chartId, index, valueStart, valueEnd);

        ['is_not','is_null','is_not_null','is_unique','is_count'].forEach(key => {
            const cb = document.getElementById(`${key}_${chartId}_${index}`);
            if (cb) {
                cb.addEventListener('change', () => {
                    const vs = document.querySelector(`[name="value_start_${chartId}_${index}"]`)?.value || '';
                    const ve = document.querySelector(`[name="value_end_${chartId}_${index}"]`)?.value || '';
                    const isNot = !!document.getElementById(`is_not_${chartId}_${index}`)?.checked;
                    const isNull = !!document.getElementById(`is_null_${chartId}_${index}`)?.checked;
                    const isNotNull = !!document.getElementById(`is_not_null_${chartId}_${index}`)?.checked;
                    const isUnique = !!document.getElementById(`is_unique_${chartId}_${index}`)?.checked;
                    const isCount = !!document.getElementById(`is_count_${chartId}_${index}`)?.checked;
                    setSummaryTextNamespaced(chartId, index, vs, ve, isNot, isNull, isNotNull, isUnique, isCount);
                });
            }
        });

        setSummaryTextNamespaced(chartId, index, valueStart, valueEnd, isNot, isNull, isNotNull, isUnique, isCount);
    }

    document.addEventListener('click', function (event) {
        document.querySelectorAll('[id^="options-container_"]').forEach(dropdown => {
            const id = dropdown.id;
            const [ , chartPart, idxPart ] = id.split('_');
            const toggleBtn = document.getElementById(`options-button_${chartPart}_${idxPart}`);
            if (!dropdown.contains(event.target) && !toggleBtn?.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
    });

    Object.entries(chartData).forEach(([id, chart]) => {
        let chartIndexCounter = 0;

        const savedFilters = safeParseFilters(chart.saved_filters);
        const tabId = chart.tab_id;
        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow p-4 flex flex-col relative";

        const actionBar = document.createElement("div");
        actionBar.className = "flex justify-between items-start gap-3 mb-10";

        let leftHtml = '';
        if (savedFilters.length > 0) {
            leftHtml = `
                <form method="post" class="" data-base-url="{% url 'create_tab_filter' 0 %}">
                    {% csrf_token %}
                    <div class="flex items-start gap-2">
                        <div id="filters-area_${id}" class="filters-area"></div>
                    </div>
                </form>
            `;
        } else {
            leftHtml = `
                <form method="post" class="" data-base-url="{% url 'create_tab_filter' 0 %}">
                    {% csrf_token %}
                    <div class="flex items-start gap-2"></div>
                </form>
            `;
        }

        /*
        <button onclick="addFilterNamespaced('${id}', '${chartIndexCounter++}');" class="text-green-600 hover:text-green-800">
            <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
            </svg>
        </button> */

        const rightHtml = `
            <div class="flex items-center gap-3 mt-1">

                <button onclick="openEditModal('${id}')" class="text-blue-600 hover:text-blue-800">
                    <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                    </svg>
                </button>
    
                <button onclick="openDeleteModal('${id}')" class="text-red-600 hover:text-red-800">
                    <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
                    </svg>
                </button>
            </div>
        `;

        actionBar.innerHTML = leftHtml + rightHtml;
        card.appendChild(actionBar);
        const form = card.querySelector("form[data-base-url]");
        if (form) {
            const base = form.getAttribute("data-base-url");
            form.action = base.replace(/0\/?$/, tabId + "/");
        }

        const chartDiv = document.createElement("div");
        chartDiv.id = `chart-${id}`;
        card.appendChild(chartDiv);
        container.appendChild(card);

        const options = {
            chart: { type: chart.type, height: 300, toolbar: { show: true } },
            series: [{ name: chart.name, data: chart.data }],
            xaxis: { type: 'category' },
            title: { text: chart.name, align: 'center' },
            legend: { position: 'right' },
            dataLabels: {
                enabled: true,
                dropShadow: { enabled: false },
                style: { colors: ['#3a3a3bff'] }
            },
        };
        new ApexCharts(chartDiv, options).render();

        if (savedFilters.length > 0) {
            savedFilters.forEach(f => {
                addFilterNamespaced(id, chartIndexCounter++, f.field_name || '', f.value_start || '', f.value_end || '', !!f.is_not, !!f.is_null, !!f.is_not_null, !!f.is_unique, !!f.is_count, f.id || null);
            });
        } else {
            addFilterNamespaced(id, chartIndexCounter++, '', '', '', false, false, false, false, false, null);
        }
    });

</script>


<script>
    function openDeleteModal(id) {
        const modalRoot = document.getElementById("modal-root");

        modalRoot.innerHTML = `
            <div id="modal-${id}" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
                    <svg class="w-16 h-16 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="mt-5 mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this chart?</h3>

                    <a href="/tables/charts/delete/${id}/" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-base inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-800">
                        Yes, I'm sure
                    </a>
                    <button type="button" onclick="closeModal()" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-base px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-modal-toggle="remove-chart-{{chart.id}}">
                        No, cancel
                    </button>
                </div>
            </div>
        `;

        document.body.classList.add("overflow-hidden");
    }

    function openEditModal(id) {
        const modalRoot = document.getElementById("modal-root");

        const chart = chartData[id];

        const fieldOptions = chart.db_field_names
            .map(f => `<option value="${f}" ${chart.x_field === f ? "selected" : ""}>${f}</option>`)
            .join("");

        const yFieldOptions = chart.db_field_names
            .map(f => `<option value="${f}" ${chart.y_field === f ? "selected" : ""}>${f}</option>`)
            .join("");

        modalRoot.innerHTML = `
            <div id="modal-${id}" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Edit Chart</h3>
                        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="closeModal()">
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                    </div>

                    <form method="POST" class="p-4 md:p-5" action="/tables/charts/edit/${id}/">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Chart Name</label>
                            <input type="text" name="name" value="${chart.name.replace(/"/g, '&quot;')}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Chart Type</label>
                            <select name="chart_type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option value="BAR" ${chart.type === "bar" ? "selected" : ""}>Bar</option>
                                <option value="LINE" ${chart.type === "line" ? "selected" : ""}>Line</option>
                                <option value="PIE"  ${chart.type === "pie" ? "selected" : ""}>Pie</option>
                            </select>
                        </div>

                        <div class="flex justify-end gap-3 mt-5">
                            <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.body.classList.add("overflow-hidden");
    }

    function closeModal() {
        document.getElementById("modal-root").innerHTML = "";
        document.body.classList.remove("overflow-hidden");
    }
</script>


{% endblock extra_js %}